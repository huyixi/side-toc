(()=>{"use strict";const e={includeH1:!1,maxDepth:6,smoothScroll:!0,compactMode:!1},t=["includeH1","maxDepth","smoothScroll","compactMode"];let n=Object.assign({},e),o="",i="",l=null;function r(t){chrome.storage.sync.get(e,(o=>{n=function(t){const n=Number(null==t?void 0:t.maxDepth),o=Number.isFinite(n)?Math.min(6,Math.max(2,Math.round(n))):e.maxDepth;return{includeH1:"boolean"==typeof(null==t?void 0:t.includeH1)?t.includeH1:e.includeH1,maxDepth:o,smoothScroll:"boolean"==typeof(null==t?void 0:t.smoothScroll)?t.smoothScroll:e.smoothScroll,compactMode:"boolean"==typeof(null==t?void 0:t.compactMode)?t.compactMode:e.compactMode}}(o),null==t||t()}))}function c(e){var t;const n=null===(t=e.textContent)||void 0===t?void 0:t.trim();return n&&n.length>0?n:"Untitled section"}function d(){const e=function(){const e=[];for(let t=n.includeH1?1:2;t<=n.maxDepth;t+=1)e.push(`h${t}`);return e.join(", ")}();if(!e)return[];const t=document.querySelectorAll(e),o=new Set,i=Array.from(t);return i.forEach((e=>{!function(e,t){const n=e.id.trim(),o=n.length>0?n:c(e).toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-"),i=o.length>0?o:"section";let l=i,r=2;for(;t.has(l)||null!==document.getElementById(l)&&document.getElementById(l)!==e;)l=`${i}-${r}`,r+=1;e.id!==l&&(e.id=l),t.add(l)}(e,o)})),i}function a(){const e=d();if(0===e.length)return"";const t=window.innerHeight,n=e.find((e=>{const n=e.getBoundingClientRect();return n.bottom>0&&n.top<t}));if(n)return n.id;let o=e[0];for(const t of e){if(!(t.getBoundingClientRect().top<=120))break;o=t}return o.id}function s(e){e!==i&&(i=e,chrome.runtime.sendMessage({action:"activeHeadingChanged",headingId:e},(()=>{chrome.runtime.lastError})))}function u(e=!1){const{pageInfo:t,signature:i}=function(){const e=d().map((e=>({id:e.id,text:c(e),level:parseInt(e.tagName.substring(1),10)}))),t=function(e){const t={Children:[]},n=[t];for(const t of e){const e={id:t.id,text:t.text,level:t.level,Children:[]};for(;n.length>1&&n[n.length-1].level>=e.level;)n.pop();n[n.length-1].Children.push(e),n.push(e)}return t.Children}(e),o=(null===(l=document.title)||void 0===l?void 0:l.trim())||(null===(a=null===(r=document.querySelector("h1"))||void 0===r?void 0:r.textContent)||void 0===a?void 0:a.trim())||"Untitled page",i=[o,n.includeH1?"h1:on":"h1:off",`max:${n.maxDepth}`,...e.map((e=>`${e.id}:${e.level}:${e.text}`))].join("|");var l,r,a;return{pageInfo:{title:o,nestedHeadings:t},signature:i}}();e||i!==o?(o=i,chrome.runtime.sendMessage({action:"sendPageInfo",title:t.title,nestedHeadings:t.nestedHeadings},(()=>{chrome.runtime.lastError})),s(a())):s(a())}chrome.runtime.onMessage.addListener(((e,t,o)=>{if(e&&"updateSidePanel"===e.action)return u(!0),o({ok:!0}),!1;if(e&&"scrollToHeading"===e.action){const t=e.headingId;return"string"==typeof t&&function(e){const t=document.getElementById(e);t&&t.scrollIntoView({behavior:n.smoothScroll?"smooth":"auto",block:"start"})}(t),o({ok:!0}),!1}return!1})),chrome.storage.onChanged.addListener(((e,n)=>{"sync"===n&&t.some((t=>t in e))&&r((()=>{o="",u(!0),null==l||l()}))})),r((()=>{u(!0),function(){let e=null,t=location.href;const n=()=>{null!==e&&window.clearTimeout(e),e=window.setTimeout((()=>{e=null,u()}),150)},o=new MutationObserver((()=>{n()}));document.documentElement&&o.observe(document.documentElement,{childList:!0,subtree:!0,characterData:!0}),window.setInterval((()=>{location.href!==t&&(t=location.href,n())}),500),window.addEventListener("popstate",n),window.addEventListener("hashchange",n)}(),function(){let e=!1;const t=()=>{e=!1,s(a())},n=()=>{e||(e=!0,window.requestAnimationFrame(t))};l=n,window.addEventListener("scroll",n,{passive:!0}),window.addEventListener("resize",n),window.addEventListener("hashchange",n),n()}()}))})();